{"version":3,"sources":["file:///Users/hanchuang/Games/RotateBlock/assets/src/Block.ts"],"names":["_decorator","CCInteger","Component","instantiate","NodeEventType","Prefab","resources","Sprite","SpriteFrame","UITransform","Vec2","Vec3","BlockEnum","GameController","ColorEnum","ccclass","property","Block","type","rotation","color","grids","used","width","height","start","generate","node","on","TOUCH_START","touchStart","getComponent","addEventListener","refresh","Math","floor","random","randomRotation","COLOR_RES","length","data","getRotation","removeAllChildren","i","GridPrefab","x","row","y","setPosition","addChild","console","log","load","err","asset","getChildByName","spriteFrame","push","event","off","TOUCH_CANCEL","touchCancel","TOUCH_MOVE","touchMove","TOUCH_END","touchEnd","Instance","currentBlock","touch","_point","_startPoint","block","result","test","getPosition","canAdd","add","index","reset","update","deltaTime","isUsed","use","active","Index"],"mappings":"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","sourcesContent":["import { _decorator, CCInteger, Component, instantiate, Node, NodeEventType, Prefab, resources, Sprite, SpriteFrame, UIOpacity, UITransform, Vec2, Vec3 } from 'cc';\nimport { BlockEnum } from './BlockEnum';\nimport { GameController } from './GameController';\nimport { ColorEnum } from './ColorEnum';\nconst { ccclass, property } = _decorator;\n\n@ccclass('Block')\nexport class Block extends Component {\n\n\n    type;\n    rotation = 0;\n    color = 0;\n\n    @property({\n        type: Prefab,\n    })\n    GridPrefab: Prefab;\n\n    @property({\n        type: CCInteger,\n    })\n    Index;\n\n    grids = [];\n\n    used;\n\n    width = 0;\n    height = 0;\n\n    start() {\n        this.generate();\n\n        this.node.on(NodeEventType.TOUCH_START, this.touchStart, this);\n\n\n        this.width = 160;\n        this.height = 160;\n\n        this.node.getComponent(UITransform).width = 80 * 2;\n        this.node.getComponent(UITransform).height = 80 * 2;\n\n\n\n        this.node.on(NodeEventType.TOUCH_START, this.touchStart, this);\n        addEventListener(\"resetBlock\", () => {\n            this.refresh()\n        })\n    }\n\n    public generate() {\n        this.type = Math.floor(Math.random() * 16);\n        this.rotation = BlockEnum.randomRotation(this.type)\n        this.color = Math.floor(Math.random() * ColorEnum.COLOR_RES.length);\n\n        let data = BlockEnum.getRotation(this.type, this.rotation);\n\n        this.node.removeAllChildren();\n\n        for (let i = 0; i < data.rotation.length; i++) {\n            let node = instantiate(this.GridPrefab);\n            let x = (data.rotation[i] % 8 - (data.row[i] * 8)) * 80 + 40;\n            let y = (data.row[i]) * 80 + 40;\n            node.setPosition(new Vec3(x, y, 0));\n            this.node.addChild(node);\n            console.log('texture/' + ColorEnum.COLOR_RES[this.color] + '/spriteFrame');\n            resources.load('texture/' + ColorEnum.COLOR_RES[this.color] + \"/spriteFrame\", SpriteFrame, (err, asset) => {\n\n                node.getChildByName(\"Grid\").getComponent(Sprite).spriteFrame = asset;\n            });\n\n            this.grids.push(node);\n        }\n\n    }\n\n    public touchStart(event) {\n        this.node.off(NodeEventType.TOUCH_START, this.touchStart, this);\n        this.node.on(NodeEventType.TOUCH_CANCEL, this.touchCancel, this);\n        this.node.on(NodeEventType.TOUCH_MOVE, this.touchMove, this, true);\n        this.node.on(NodeEventType.TOUCH_END, this.touchEnd, this);\n        console.log(\"start\");\n        GameController.Instance.currentBlock = this.node;\n    }\n\n    public touchMove(event) {\n        // console.log(event.touch);\n        this.node.setPosition(new Vec3(event.touch._point.x - 480,\n            event.touch._point.y - event.touch._startPoint.y));\n    }\n\n    public touchEnd(event) {\n        console.log(\"end\");\n        this.node.on(NodeEventType.TOUCH_START, this.touchStart, this);\n        this.node.off(NodeEventType.TOUCH_CANCEL, this.touchCancel, this);\n        this.node.off(NodeEventType.TOUCH_MOVE, this.touchMove, this);\n        this.node.off(NodeEventType.TOUCH_END, this.touchEnd, this);\n\n        let block = { type: this.type, rotation: this.rotation };\n        let result = GameController.Instance.test(new Vec2(this.node.getPosition().x, this.node.getPosition().y - this.height),\n            block);\n        console.log(\"能放\" + result.canAdd);\n        if (result.canAdd) {\n            GameController.Instance.add(result.index, block);\n        } else {\n            this.reset();\n        }\n    }\n\n    public touchCancel(event) {\n        this.node.on(NodeEventType.TOUCH_START, this.touchStart, this);\n        this.node.off(NodeEventType.TOUCH_CANCEL, this.touchCancel, this);\n        this.node.off(NodeEventType.TOUCH_MOVE, this.touchMove, this);\n        this.node.off(NodeEventType.TOUCH_END, this.touchEnd, this);\n\n        let block = { type: this.type, rotation: this.rotation };\n        let result = GameController.Instance.test(new Vec2(this.node.getPosition().x, this.node.getPosition().y - this.height),\n            block);\n        console.log(\"能放\" + result.canAdd);\n        if (result.canAdd) {\n            GameController.Instance.add(result.index, block);\n        } else {\n            this.reset();\n        }\n    }\n\n    update(deltaTime: number) {\n\n    }\n\n    public isUsed() {\n        return this.used;\n    }\n\n    public use() {\n        this.node.active = false;\n    }\n\n    public reset() {\n        this.node.setPosition((this.Index - 1) * (-200), -100);\n        // this.node.getComponent(UIOpacity).opacity = 255;\n        this.node.active = true;\n    }\n\n    public refresh() {\n        this.generate();\n        this.reset();\n    }\n\n\n}\n\n"]}